<<<<<<< HEAD
from django.http import JsonResponse
from django.shortcuts import render, redirect
from django.views.generic import ListView, DetailView,UpdateView, CreateView, DeleteView
from django.contrib import messages
from .forms import IdolForm, IdolTitleForm
from .models import IdolImage

class IdolListView(ListView):
    model = IdolImage
    template_name ='moon/idol-home.html'
    context_object_name = 'idols'
    ordering = ['-created_at']
    paginate_by = 8

class IdolCreateView(CreateView):
    model = IdolImage
    fields = ['title', 'image']
    
class IdolDetailView(DetailView):
    model = IdolImage

class IdolUpdateView(UpdateView):
    model = IdolImage
    fields = ['title', 'image']

    def form_valid(self, form):
        messages.success(self.request, "수정되었습니다.")
        return super().form_valid(form)

class IdolDeleteView(DeleteView):
    model = IdolImage
    success_url = '/idol/'
    
def idol_home(request):
    idols = IdolImage.objects.order_by('title').all()
    return render(request, 'moon/idol-home.html', {'idols': idols})


def upload(request):
    if request.method == 'POST':
        form = IdolForm(request.POST, request.FILES)
        if form.is_valid():
            form.save()
            return redirect('idol-home')
    else:
        form = IdolForm()
    return render(request, 'moon/upload.html', {'form': form})


def detail(request, pk):
    idol = IdolImage.objects.get(pk=pk)
    if request.method == 'POST':
        form = IdolTitleForm(request.POST)
        if form.is_valid():
            idol.title = form.cleaned_data['title']
            idol.save()
            return redirect('idol-detail', pk=idol.pk) # 수정 후 상세 페이지로 다시 리디렉션
    form = IdolTitleForm(initial={'title': idol.title})
    return render(request, 'moon/detail.html', {'idol': idol, 'form': form})

def delete(request, pk):
    if request.method == 'POST':
        image = IdolImage.objects.get(pk=pk)
        image.delete()
        return redirect('idol-home')
    image = IdolImage.objects.get(pk=pk)
    return render(request, 'moon/delete.html', {'image': image})

def idol_edit(request, pk):
    if request.method == 'POST':
        form = request.form.get('title')
        if form.is_valid():
            idol = IdolImage.objects.get(pk=pk)
            idol.title = form.cleaned_data['title']
            form.save()
            return redirect('idol-home')
    return render(request, 'moon/upload.html', {'form': form})

def update_idol_title(request, pk):
    if request.method == 'POST' and request.headers.get('x-requested-with') == 'XMLHttpRequest':
        try:
            idol = IdolImage.objects.get(pk=pk)
            new_title = request.POST.get('title')
            if new_title and new_title.strip():
                idol.title = new_title
                idol.save()
                return JsonResponse({'success': True, 'new_title': idol.title})
            else:
                return JsonResponse({'success': False, 'error': 'Title cannot be empty.'}, status=400)
        except IdolImage.DoesNotExist:
            return JsonResponse({'success': False, 'error': 'Idol not found.'}, status=404)
=======
from django.http import JsonResponse
from django.shortcuts import render, redirect
from django.views.generic import ListView, DetailView,UpdateView, CreateView, DeleteView
from django.contrib import messages
from .forms import IdolForm, IdolTitleForm
from .models import IdolImage

class IdolListView(ListView):
    model = IdolImage
    template_name ='moon/idol-home.html'
    context_object_name = 'idols'
    ordering = ['-created_at']
    paginate_by = 8

class IdolCreateView(CreateView):
    model = IdolImage
    fields = ['title', 'image']
    
class IdolDetailView(DetailView):
    model = IdolImage

class IdolUpdateView(UpdateView):
    model = IdolImage
    fields = ['title', 'image']

    def form_valid(self, form):
        messages.success(self.request, "수정되었습니다.")
        return super().form_valid(form)

class IdolDeleteView(DeleteView):
    model = IdolImage
    success_url = '/idol/'
    
def idol_home(request):
    idols = IdolImage.objects.order_by('title').all()
    return render(request, 'moon/idol-home.html', {'idols': idols})


def upload(request):
    if request.method == 'POST':
        form = IdolForm(request.POST, request.FILES)
        if form.is_valid():
            form.save()
            return redirect('idol-home')
    else:
        form = IdolForm()
    return render(request, 'moon/upload.html', {'form': form})


def detail(request, pk):
    idol = IdolImage.objects.get(pk=pk)
    if request.method == 'POST':
        form = IdolTitleForm(request.POST)
        if form.is_valid():
            idol.title = form.cleaned_data['title']
            idol.save()
            return redirect('idol-detail', pk=idol.pk) # 수정 후 상세 페이지로 다시 리디렉션
    form = IdolTitleForm(initial={'title': idol.title})
    return render(request, 'moon/detail.html', {'idol': idol, 'form': form})

def delete(request, pk):
    if request.method == 'POST':
        image = IdolImage.objects.get(pk=pk)
        image.delete()
        return redirect('idol-home')
    image = IdolImage.objects.get(pk=pk)
    return render(request, 'moon/delete.html', {'image': image})

def idol_edit(request, pk):
    if request.method == 'POST':
        form = request.form.get('title')
        if form.is_valid():
            idol = IdolImage.objects.get(pk=pk)
            idol.title = form.cleaned_data['title']
            form.save()
            return redirect('idol-home')
    return render(request, 'moon/upload.html', {'form': form})

def update_idol_title(request, pk):
    if request.method == 'POST' and request.headers.get('x-requested-with') == 'XMLHttpRequest':
        try:
            idol = IdolImage.objects.get(pk=pk)
            new_title = request.POST.get('title')
            if new_title and new_title.strip():
                idol.title = new_title
                idol.save()
                return JsonResponse({'success': True, 'new_title': idol.title})
            else:
                return JsonResponse({'success': False, 'error': 'Title cannot be empty.'}, status=400)
        except IdolImage.DoesNotExist:
            return JsonResponse({'success': False, 'error': 'Idol not found.'}, status=404)
>>>>>>> 5cfd106dbc2f54bb5d33a8ff7acb54b2c0160108
    return JsonResponse({'success': False, 'error': 'Invalid request.'}, status=400)